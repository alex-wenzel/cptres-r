---
title: "10x_5_15 Hallmarks Interferon Debug"
output: html_notebook
---

After the first GSEA analysis with `fgsea` on 5/16/2018 we noticed that the `Small-1` cluster (clone R18 step 15)
did not have enrichment in the Hallmarks Interferon gene set as expected. Possible reasons for this are that
we don't have enough genes to start with, there are < 10 genes in the hallmarks Interferon set, or 
`Seurat::FindAllMarkers` is being too conservative due to the sparsity of the data.

### Libraries

```{r results="hide"}
library(grid)
library(plyr)
library(dplyr)
library(GSA)
library(liger)
library(matrixStats)
library(parallel)
library(pheatmap)
library(Seurat)
library(stringr)
library(reshape2)
library(fgsea)
```

### Preprocessing

Load the `10x_5_15` dataset and populate a `Seurat` object. Normalize and scale the data and regress out
the cell cycle signature to recreate the exact data used for GSEA input

```{r results="hide"}
scdata <- Read10X(data.dir="../full_28k/raw28k/")
sc <- CreateSeuratObject(raw.data=scdata, min.cells=3, min.genes=3, project="10X_CPTRES")
sc <- NormalizeData(object=sc, normalization.method="LogNormalize", scale.factor=10000)
sc <- ScaleData(object=sc)
cc.genes <- readLines(con="../satija_cell_cycle/regev_lab_cell_cycle_genes.txt")
s.genes <- cc.genes[1:43]
g2m.genes <- cc.genes[44:97]
sc <- CellCycleScoring(object=sc, s.genes=s.genes, g2m.genes=g2m.genes, set.ident=T)
sc <- ScaleData(object=sc, vars.to.regress=c("S.Score", "G2M.Score"))
```

### Cluster Assignment

Load the original clustering from `10X`+manual merging and assign as labels to the cells in 
the `Seurat` object.

```{r}
cluster.names <- c("Large", "Small-1", "Medium-1", "Large", "Small-3",
                   "Large", "Medium-1", "Medium-2", "Small-2", "Medium-2",
                   "Small-4", "Medium-1", "Small-2", "Medium-2")
names(cluster.names) <- 1:14
get.cluster.name <- function(num) {
  cluster.names[num]
}
full.14.clusters <- read.csv("../full_28k/orig_graphclust_14/clusters.csv")$Cluster
full.14.clusters <- as.factor(sapply(full.14.clusters, get.cluster.name))
attributes(full.14.clusters)$names <- sc@cell.names
sc@ident <- full.14.clusters
```

### Load Previous Markers

Load the markers file generated by [`10x_5_15_gsea.Rmd`](https://github.com/alex-wenzel/cptres-r/blob/master/10x_5_15_gsea.Rmd). The parameters
for these markers are that genes must be seen in 25% of cells (`min.pct=0.25`) and pass a differential expression
threshold of 0.25 (`thresh.use=0.25`).

```{r}
sc.markers <- read.csv("../10x_5_15_gsea_markers.tsv", sep='\t', stringsAsFactors = F)
```

### Load Hallmarks Interferon Signaling Genes

```{r results="hide"}
hallmarks.full <- GSA.read.gmt("../msigdb/h.all.v6.1.symbols.gmt")
hallmarks <- hallmarks.full$genesets
names(hallmarks) <- hallmarks.full$geneset.names
interferon.alpha.genes <- hallmarks[["HALLMARK_INTERFERON_ALPHA_RESPONSE"]]
interferon.gamma.genes <- hallmarks[["HALLMARK_INTERFERON_GAMMA_RESPONSE"]]
```

```{r}
paste("Interferon Alpha gene set length: ", length(interferon.alpha.genes))
paste("Interferon Gamma gene set length: ", length(interferon.gamma.genes))
```


### Count Matrix Genes

Counts how many of the interferon genes are in the overall expression matrix

```{r}
all.sc.genes <- attr(sc@scale.data, "dimnames")[[1]]

paste("Interferon Alpha Genes in full matrix: ",
      length(intersect(all.sc.genes, interferon.alpha.genes)))

paste("Interferon Gamma Genes in full matrix: ",
      length(intersect(all.sc.genes, interferon.gamma.genes)))
```

### Generate Markers Non-Stringent Parameters

This code calls `Seurat::FindAllMarkers` with `min.pct=0` and `thresh.use=0`. This will
likely take a *very* long time. If this file already exists and the parameters/input hasn't
changed, run the cell after this one instead to load it.

```{r results="hide"}
sc.markers.comp <- FindAllMarkers(object=sc, min.pct=0.0, thresh.use=0.0)
write.table(sc.markers.comp, "../10x_5_15_gsea_markers_params0.tsv", quote=FALSE, row.names=FALSE, sep='\t')
```

```{r}
sc.markers.comp <- read.csv("../10x_5_15_gsea_markers_params0.tsv", sep='\t', stringsAsFactors = F)
```

### Compare Stringent Vs Lenient Markers

**Total Markers**

```{r}
paste("Total lenient markers: ", length(sc.markers.comp[,1]))
paste("Total stringent markers: ", length(sc.markers[,1]))
```

**Markers Per Cluster**

```{r}
table(sc.markers.comp$cluster)
table(sc.markers$cluster)
```

**Interferon Genes Per Cluster**

```{r}
## Lenient Interferon Alpha
scm.comp.ifna <- sc.markers.comp[sc.markers.comp$gene %in% interferon.alpha.genes,]
table(scm.comp.ifna$cluster)

## Lenient Interferon Gamma
scm.comp.ifng <- sc.markers.comp[sc.markers.comp$gene %in% interferon.gamma.genes,]
table(scm.comp.ifng$cluster)

## Stringent Interferon Alpha
scm.ifna <- sc.markers[sc.markers$gene %in% interferon.alpha.genes,]
table(scm.ifna$cluster)

## Stringent Interferon Gamma
scm.ifng <- sc.markers[sc.markers$gene %in% interferon.gamma.genes,]
table(scm.ifng$cluster)
```

